{% extends 'base.html' %}
{% block title %}Global Live Feed{% endblock %}
{% block content %}
  <h2>Global Live Feed</h2>
  <p>All attempt events (staff/admin only). Use this to monitor all students in real time.</p>
  <div id="global-log" style="max-height:70vh; overflow:auto; border:1px solid #ddd; padding:10px; background:#fff"></div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const socket = io();
    const container = document.getElementById('global-log');
    socket.on('connect', ()=>{ socket.emit('join_all_attempts', {}); });
    socket.on('joined_all', ()=>{ console.log('joined global room'); });
    socket.on('attempt_event_all', function(payload){
      try{
        const r = payload.record;
        const wrapper = document.createElement('div');
        wrapper.style.borderTop = '1px solid #eee';
        wrapper.style.padding = '6px';
        wrapper.innerHTML = `<small class="text-muted">${r.ts} â€” attempt ${payload.attempt_id}</small> <strong> ${r.event}</strong><div><pre style="white-space:pre-wrap">${JSON.stringify(r.data||{}, null, 2)}</pre></div>`;
        container.prepend(wrapper);
      }catch(e){ console.warn(e); }
    });
  </script>
{% endblock %}
